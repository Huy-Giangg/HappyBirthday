<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Happy birthday</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background: #000;
            font-family: 'Courier New', Courier, monospace;
        }
        canvas {
            display: block;
        }
    </style>
</head>
<body>

<canvas id="canvas"></canvas>

<script>
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');

    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;

    // --- CẤU HÌNH ---
    const CONFIG = {
        bgSpeed: 20,           // Tốc độ mưa rơi
        bgFade: 0.1,           // Độ mờ đuôi
        particleEase: 0.05,    // Tốc độ chữ bay vào
        textScale: 100,        // Cỡ chữ
        gap: 5                 
    };

    const chars = 'HAPPYBIRTHDAYTOYOU';
    const charArray = chars.split('');
    
    // --- PHẦN 1: NỀN MƯA MATRIX ---
    const fontSize = 14;
    const columns = canvas.width / fontSize;
    const drops = [];
    for (let i = 0; i < columns; i++) drops[i] = 1;

    // --- PHẦN 2: CHỮ HỘI TỤ ---
    let particles = [];
    
    class MatrixParticle {
        constructor(x, y) {
            this.targetX = x;
            this.targetY = y;
            if (Math.random() > 0.5) {
                this.x = Math.random() > 0.5 ? -50 : canvas.width + 50;
                this.y = Math.random() * canvas.height;
            } else {
                this.x = Math.random() * canvas.width;
                this.y = Math.random() > 0.5 ? -50 : canvas.height + 50;
            }
            this.char = charArray[Math.floor(Math.random() * charArray.length)];
            this.color = '#ff69b4'; 
        }

        update() {
            this.x += (this.targetX - this.x) * CONFIG.particleEase;
            this.y += (this.targetY - this.y) * CONFIG.particleEase;
            if (Math.random() > 0.95) {
                this.char = charArray[Math.floor(Math.random() * charArray.length)];
            }
        }

        draw() {
            ctx.fillStyle = this.color;
            ctx.shadowBlur = 20;
            ctx.shadowColor = '#ff1493'; 
            ctx.fillText(this.char, this.x, this.y);
            ctx.shadowBlur = 0; 
        }

        changeTarget(newX, newY) {
            this.targetX = newX;
            this.targetY = newY;
        }
    }

    function getTextCoordinates(text) {
        const bgCanvas = document.createElement('canvas');
        const bgCtx = bgCanvas.getContext('2d');
        bgCanvas.width = canvas.width;
        bgCanvas.height = canvas.height;

        let size = CONFIG.textScale;
        if (text.length > 5 && text.length <= 10) size = size * 0.9; 
        if (text.length > 10) size = size * 0.7; 

        bgCtx.font = `bold ${size}px Arial`;
        bgCtx.fillStyle = '#fff';
        bgCtx.textAlign = 'center';
        bgCtx.textBaseline = 'middle';

        const lines = text.split('\n');
        const lineHeight = size * 1.0; 
        const startY = (canvas.height - (lines.length - 1) * lineHeight) / 2;

        lines.forEach((line, index) => {
            bgCtx.fillText(line, canvas.width / 2, startY + (index * lineHeight));
        });

        const imageData = bgCtx.getImageData(0, 0, canvas.width, canvas.height);
        const data = imageData.data;
        const coords = [];

        for (let y = 0; y < canvas.height; y += CONFIG.gap) {
            for (let x = 0; x < canvas.width; x += CONFIG.gap) {
                if (data[(y * canvas.width + x) * 4 + 3] > 128) {
                    coords.push({ x, y });
                }
            }
        }
        return coords;
    }

    function initParticles(text) {
        const coords = getTextCoordinates(text);
        if (particles.length < coords.length) {
            const diff = coords.length - particles.length;
            for (let i = 0; i < diff; i++) {
                particles.push(new MatrixParticle(canvas.width/2, canvas.height/2));
            }
        }
        particles.forEach((p, i) => {
            if (i < coords.length) {
                p.changeTarget(coords[i].x, coords[i].y);
                p.color = '#ff69b4'; 
            } else {
                p.changeTarget(Math.random() * canvas.width, Math.random() * canvas.height);
                p.color = 'rgba(0,0,0,0)'; 
            }
        });
    }

    const timeline = [
        { text: "3", time: 5500 },
        { text: "2", time: 3500 },
        { text: "1", time: 3500 },
        { text: "HAPPY\nBIRTHDAY", time: 8000 },
        { text: "VŨ PHƯƠNG MY", time: 8000 },
        { text: "18-02\n2005", time: 5000 },
        { text: "I LOVE\nYOU", time: 5000 },
        { text: "HẸ HẸ HẸ", time: 5000 },
        { text: "HẤP =))", time: 8000 }
    ];
    let currentStep = 0;

    function runTimeline() {
        if (currentStep >= timeline.length) currentStep = 3; 
        initParticles(timeline[currentStep].text);
        setTimeout(() => {
            currentStep++;
            runTimeline();
        }, timeline[currentStep].time);
    }

    let lastTime = 0;
    const interval = 1000 / CONFIG.bgSpeed;

    function draw(currentTime) {
        requestAnimationFrame(draw);

        const deltaTime = currentTime - lastTime;
        if (deltaTime < interval) return;
        lastTime = currentTime - (deltaTime % interval);

        // Vẽ nền mờ
        ctx.fillStyle = `rgba(0, 0, 0, ${CONFIG.bgFade})`;
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        ctx.font = fontSize + 'px monospace';

        // Vẽ mưa phát sáng
        ctx.shadowBlur = 8;  
        ctx.shadowColor = 'rgba(255, 255, 255, 0.8)'; 

        for (let i = 0; i < drops.length; i++) {
            const text = charArray[Math.floor(Math.random() * charArray.length)];
            const x = i * fontSize;
            const y = drops[i] * fontSize;

            ctx.fillStyle = '#ffffff'; 
            ctx.fillText(text, x, y);

            if (y > canvas.height && Math.random() > 0.975) {
                drops[i] = 0;
            }
            drops[i]++;
        }
        
        ctx.shadowBlur = 0;

        // Vẽ chữ chính
        particles.forEach(p => {
            p.update();
            if (p.color !== 'rgba(0,0,0,0)') { 
                p.draw();
            }
        });
    }

    // --- PHẦN THAY ĐỔI: TRÌ HOÃN 3 GIÂY ---
    
    // 1. Chạy background (mưa rơi) ngay lập tức
    draw(0);

    // 2. Đợi 3000ms (3 giây) rồi mới bắt đầu đếm ngược
    setTimeout(() => {
        initParticles(timeline[0].text);
        runTimeline();
    }, 6000);

    // Xử lý Resize
    window.addEventListener('resize', () => {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        // Chỉ cập nhật nếu timeline đã bắt đầu chạy
        if (currentStep < timeline.length) {
            initParticles(timeline[currentStep].text);
        }
    });

</script>
</body>
</html>
